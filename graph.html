<!doctype html>
<meta charset=utf-8>
<meta name=viewport content=width=device-width>
<meta name=apple-mobile-web-app-capable content=yes>
<meta name=apple-mobile-web-app-status-bar-style content=black-translucent>
<meta name=theme-color content=black>
<link rel=icon href=graph.png>
<link rel=apple-touch-icon href=graph.png>
<canvas width=0 height=0 id=graph></canvas>
<div id=loading>Loading...</div>
<style>
  * { margin: 0 }
  html, body { height: 100% }
  html { background: black; font-size: 16px; line-height: 20px }
  body { display: flex; align-items: center; justify-content: center }
  #loading { font: 10pt sans-serif; color: #666; padding: 1ch 1em }
</style>
<script>
  ;({ abs, min, max, pow, round, floor, log10 } = Math)
  lc = x => x.toLowerCase(), uc = x => x.toUpperCase()
  replace = (x, ys) => ys.reduce((a, y) => a.replace(...y), x)
  wget = async x => (await fetch(x)).json()

  tostr = (x, y) => x.toLocaleString(`default`, y)
  todate = x => new Date(x).toISOString().replace(/T.*/, ``)
  tomonth = x => tostr(new Date(x), { month: `long` })
  tousd = x => `$${fixunits(tostr(+x, { notation: `compact` }))}`
  fixunits = x => replace(x, [[`K`, `k`], [`M`, `mm`]])

  dpr = devicePixelRatio
  db = localStorage

  CP_API = `https://api.coinpaprika.com/v1`
  CG_API = `https://api.coingecko.com/api/v3`
  start = todate(new Date(new Date().setUTCMonth(-6, 1)).setUTCHours(0, 0, 0))
  symbol = location.search.substring(1) || `btc`
  pen = graph.getContext(`2d`)

  document.title = `${uc(symbol)}USD`

  get_cg_id = async () => (await Promise.all(
    (await wget(`${CG_API}/coins/list`))
      .filter(y => lc(y.symbol) == lc(symbol))
      .map(x => wget(`${CG_API}/coins/${x.id}?market_data=true`))
  )).sort((x, y) => y.market_cap_rank - x.market_cap_rank)[0].id

  get_cp_id = async () => (await wget(`${CP_API}/coins`))
    .find(y => lc(y.symbol) == lc(symbol)).id

  Promise.resolve().then(async () => {
    if (location.search || location.hostname != `localhost`) {
      cp_id = db[`cp_id_${symbol}`] = db[`cp_id_${symbol}`] || await get_cp_id()
      cp_url = `${CP_API}/coins/${cp_id}/ohlcv/historical`
        + `?start=${start}&limit=366`
      cg_id = db[`cg_id_${symbol}`] = db[`cg_id_${symbol}`] || await get_cg_id()
      cg_url = `${CG_API}/coins/${cg_id}?market_data=true`
    } else {
      cp_url = `bitcoin.json`
    }

    ;[cg_data, cp_data] = await Promise.all([wget(cg_url), wget(cp_url)])
    loading.remove()
    draw()
    onresize = draw
  })

  draw = () => {
    graph.width = 0
    graph.height = 0
    W = innerWidth
    H = innerHeight
    graph.width = W * dpr
    graph.height = H * dpr
    graph.style.width = `${W}px`
    graph.style.height = `${H}px`
    pen.scale(dpr, dpr)
    pen.fillStyle = `black`
    pen.fillRect(0, 0, W, H)

    aw = W - 50
    data = cp_data.slice(-floor(aw / 4))
    dw = floor(aw / data.length)                // day width
    bw = floor(dw / 3) * 2 + 1                  // box width

    Ω = max(...data.map(x => x.high))
    Ω = min(max(cg_data.market_data.ath.usd, Ω), Ω * 5)
    tick = pow(10, floor(log10(Ω / 4.5)))

    for (let a = tick; a < Ω; a += tick) {
      let y = H * (1 - a / Ω)
      pen.save()
      pen.strokeStyle = `#111`
      pen.fillStyle = `#444`
      pen.textBaseline = `middle`
      pen.textAlign = `center`
      let w = 40
      pen.strokeRect(w, y, W - w, 0)
      pen.font = `10px sans-serif`
      pen.fillText(tousd(a), w / 2, y)
      pen.restore()
    }

    for (let i = 0; i < data.length; i++) {
      let { open, close, low, high, time_open } = data[i]
      let bx = dw * i + dw - bw                 // box x
      let by = H * (1 - min(open, close) / Ω)   // box y
      let bh = H * abs(close - open) / Ω        // box height
      let ly = H * (1 - low / Ω)                // line y
      let lh = H * (high - low) / Ω             // line height

      if (time_open.replace(/.*(..)T.*/, `$1`) == `01`) {
        pen.save()
        pen.strokeStyle = `#111`
        pen.fillStyle = `#444`
        pen.strokeRect(bx - floor((dw - bw) / 2) - .5, 0, 0, H)
        pen.font = `10px Menlo, monospace`
        pen.textAlign = `center`
        pen.textBaseline = `top`
        pen.fillText(tomonth(time_open), dw * (i + 15), 5)
        pen.restore()
      }

      if (close >= open) {
        pen.strokeStyle = `#8f8`
        pen.fillStyle = `black`
      } else {
        pen.strokeStyle = `red`
        pen.fillStyle = `red`
      }

      pen.strokeRect(bx + bw / 2, ly, 0, -lh)
      pen.fillRect(bx, by, bw, -bh)
      pen.strokeRect(bx + .5, by - .5, bw - 1, -(bh - 1))

      if (i == data.length - 1) {
        let y = H * (1 - close / Ω)
        pen.save()
        pen.fillStyle = close >= open ? `#8f8` : `red`
        pen.textBaseline = `middle`
        pen.textAlign = `left`
        pen.font = `10px sans-serif`
        pen.fillText(`$${(
          close >= 1000 ? round(close) : close
        ).toLocaleString().replace(/(\...).*/, `$1`)}`, (i + 1) * dw + 5, y)
        pen.restore()
      }
    }
  }
</script>
